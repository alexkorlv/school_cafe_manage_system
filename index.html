<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Школьная столовая</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 40px; text-align: center; }
        .card { background: white; padding: 30px; margin: 20px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .tabs { display: flex; gap: 10px; margin: 20px; flex-wrap: wrap; }
        .tab { padding: 15px 25px; background: #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.3s; font-weight: 600; border: none; font-size: 16px; }
        .tab:hover { background: #d1d5db; transform: translateY(-2px); }
        .tab.active { background: #2563eb; color: white; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); }
        input, select, textarea, button { padding: 14px; margin: 10px 0; border: 2px solid #e5e7eb; border-radius: 10px; width: 100%; font-size: 16px; }
        button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; cursor: pointer; font-weight: bold; transition: all 0.3s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        button:disabled { background: #9ca3af; cursor: not-allowed; transform: none; }
        .menu-item { border: 2px solid #e5e7eb; padding: 25px; margin: 20px 0; border-radius: 15px; transition: all 0.3s; background: white; }
        .menu-item:hover { border-color: #2563eb; box-shadow: 0 8px 25px rgba(37, 99, 235, 0.15); transform: translateY(-5px); }
        .success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px; border-radius: 10px; margin: 15px 0; }
        .error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 15px; border-radius: 10px; margin: 15px 0; }
        .info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 15px; border-radius: 10px; margin: 15px 0; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 25px; }
        .user-info { background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); padding: 20px; border-radius: 15px; margin: 20px 0; border-left: 5px solid #2563eb; }
        .balance { color: #059669; font-weight: bold; font-size: 1.4em; }
        .order-item { background: #f8fafc; padding: 20px; border-radius: 15px; margin: 15px 0; border-left: 5px solid #2563eb; }
        .status { padding: 8px 16px; border-radius: 25px; font-size: 0.9rem; font-weight: bold; display: inline-block; }
        .status.pending { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .status.served { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .status.cancelled { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        

        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .quick-actions { display: flex; gap: 15px; flex-wrap: wrap; }
        .action-btn { padding: 12px 24px; border-radius: 10px; background: #f3f4f6; border: none; cursor: pointer; transition: all 0.3s; }
        .action-btn:hover { background: #2563eb; color: white; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); text-align: center; }
        .stat-value { font-size: 2.5em; font-weight: bold; color: #2563eb; margin: 10px 0; }
        .stat-label { color: #6b7280; font-size: 0.9em; }
        

        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .tabs { flex-direction: column; }
            .tab { width: 100%; text-align: center; }
            .dashboard-header { flex-direction: column; gap: 15px; }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1 style="font-size: 2.5em; margin-bottom: 10px;">🏫 Школьная столовая</h1>
        <p style="font-size: 1.2em; opacity: 0.9;">Московская предпрофессиональная олимпиада школьников</p>
        <p style="font-size: 0.9em; opacity: 0.8; margin-top: 10px;">Профиль "Информационные технологии" • Командный кейс №2</p>
        <div id="server-status" style="margin-top: 20px; padding: 10px 20px; background: rgba(255,255,255,0.1); border-radius: 10px; display: inline-block;">
            <span id="status-indicator" style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: #ef4444; margin-right: 10px;"></span>
            <span id="status-text">Проверка соединения...</span>
        </div>
    </header>

    <div class="tabs">
        <div class="tab active" onclick="showTab('menu')">📋 Меню</div>
        <div class="tab" onclick="showTab('login')">👤 Вход</div>
        <div class="tab" onclick="showTab('register')">📝 Регистрация</div>
        <div class="tab" onclick="showTab('profile')">👤 Профиль</div>
        <div class="tab" onclick="showTab('orders')">📦 Заказы</div>
        <div class="tab" onclick="showTab('purchases')">🛒 Заявки</div>
        <div class="tab" onclick="showTab('reports')">📊 Отчеты</div>
        <div class="tab" onclick="showTab('dish-management')">🍽️ Управление блюдами</div>
    </div>


    <div id="menu-tab" class="card">
        <div class="dashboard-header">
            <h2>📋 Меню столовой</h2>
            <div class="quick-actions">
                <button class="action-btn" onclick="loadMenu()">🔄 Обновить</button>
                <select id="category-filter" onchange="loadMenu()" style="width: auto; padding: 10px 20px;">
                    <option value="">Все категории</option>
                    <option value="завтрак">Завтраки</option>
                    <option value="обед">Обеды</option>
                    <option value="напиток">Напитки</option>
                </select>
            </div>
        </div>
        <div id="menu" class="grid"></div>
    </div>


    <div id="login-tab" class="card" style="display: none;">
        <h2>👤 Вход в систему</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
            <div>
                <h3>Форма входа</h3>
                <input type="text" id="username" placeholder="Логин" value="student1">
                <input type="password" id="password" placeholder="Пароль" value="password123">
                <button onclick="login()">Войти в систему</button>
                <div id="login-result"></div>
            </div>
            <div>
                <h3>Тестовые аккаунты</h3>
                <div class="user-info">
                    <p><strong>👨‍🎓 Ученик:</strong> student1 / password123</p>
                    <p><em>Баланс: 1000 руб. | Может заказывать блюда</em></p>
                </div>
                <div class="user-info">
                    <p><strong>👨‍🍳 Повар:</strong> cook1 / password123</p>
                    <p><em>Может отмечать выданные заказы и создавать заявки</em></p>
                </div>
                <div class="user-info">
                    <p><strong>👨‍💼 Админ:</strong> admin1 / password123</p>
                    <p><em>Полный доступ ко всем функциям системы</em></p>
                </div>
                <div id="current-user" style="display: none; margin-top: 30px;">
                    <div class="user-info">
                        <h4>✅ Вы вошли как:</h4>
                        <p><strong>Имя:</strong> <span id="user-name"></span></p>
                        <p><strong>Роль:</strong> <span id="user-role"></span></p>
                        <p><strong>Баланс:</strong> <span id="user-balance" class="balance"></span></p>
                        <button onclick="logout()" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); margin-top: 15px;">Выйти из системы</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div id="register-tab" class="card" style="display: none;">
        <h2>📝 Регистрация нового пользователя</h2>
        <div style="max-width: 500px; margin: 0 auto;">
            <input type="text" id="reg-username" placeholder="Логин (например, student2)">
            <input type="password" id="reg-password" placeholder="Пароль">
            <input type="text" id="reg-fullname" placeholder="ФИО (например, Иванов Иван)">
            <select id="reg-role">
                <option value="0">Ученик</option>
                <option value="1">Повар</option>
                <option value="2">Администратор</option>
            </select>
            <input type="text" id="reg-class" placeholder="Класс (например, 10А)">
            <button onclick="register()">Зарегистрироваться</button>
            <div id="register-result"></div>
        </div>
    </div>


    <div id="profile-tab" class="card" style="display: none;">
        <h2>💰 Профиль и баланс</h2>
        <div id="profile-content">
            <p class="info">Для просмотра профиля необходимо войти в систему</p>
        </div>
    </div>


    <div id="orders-tab" class="card" style="display: none;">
        <h2>📦 Мои заказы</h2>
        <div id="orders-content">
            <p class="info">Для просмотра заказов необходимо войти в систему</p>
        </div>
    </div>


    <div id="purchases-tab" class="card" style="display: none;">
        <h2>🛒 Заявки на закупку</h2>
        <div id="purchases-content">
            <p class="info">Для работы с заявками необходимо войти как повар или администратор</p>
        </div>
    </div>


    <div id="reports-tab" class="card" style="display: none;">
        <h2>📊 Отчеты и статистика</h2>
        <div id="reports-content">
            <p class="info">Для просмотра отчетов необходимо войти как администратор</p>
        </div>
    </div>

    <div id="dish-management-tab" class="card" style="display: none;">
        <h2>🍽️ Управление меню</h2>
        <div id="dish-management-content">
            <p class="info">Для управления меню необходимо войти как администратор</p>
        </div>
    </div>




    <footer style="text-align: center; padding: 30px; color: #6b7280; background: #f9fafb; margin-top: 30px;">
        <p>Школьная столовая © 2026 • Командный кейс №2 "Управление столовой"</p>
        <p>Московская предпрофессиональная олимпиада школьников • Профиль "Информационные технологии"</p>
        <p id="connection-info" style="margin-top: 15px; font-size: 0.9em;">API: http://localhost:5000 • Статус: <span id="api-connection">проверка...</span></p>
    </footer>
</div>

<script>

    const API_URL = 'http://localhost:5000/api';
    let currentUser = null;
    let authToken = null;



    async function checkServer() {
        try {
            const response = await fetch(`${API_URL}/health`);
            const data = await response.json();
            
            document.getElementById('status-indicator').style.background = '#10b981';
            document.getElementById('status-text').textContent = 'Сервер работает';
            document.getElementById('api-connection').textContent = 'работает';
            document.getElementById('api-connection').style.color = '#10b981';
            
            return true;
        } catch (error) {
            document.getElementById('status-indicator').style.background = '#ef4444';
            document.getElementById('status-text').textContent = 'Сервер недоступен';
            document.getElementById('api-connection').textContent = 'ошибка';
            document.getElementById('api-connection').style.color = '#ef4444';
            
            return false;
        }
    }


    function checkAuth() {
        const token = localStorage.getItem('token');
        const user = localStorage.getItem('user');
        
        if (token && user) {
            try {
                currentUser = JSON.parse(user);
                authToken = token;
                updateUIAfterLogin();
            } catch (e) {
                console.error('Ошибка парсинга данных пользователя:', e);
                localStorage.removeItem('token');
                localStorage.removeItem('user');
            }
        }
    }

    function showTab(tabName) {
        console.log('🔄 Показываем вкладку:', tabName);

        document.querySelectorAll('[id$="-tab"]').forEach(tab => {
            tab.style.display = 'none';
        });

        document.querySelectorAll('.tab').forEach(tabBtn => {
            tabBtn.classList.remove('active');
        });


        const tabContent = document.getElementById(`${tabName}-tab`);
        if (tabContent) {
            tabContent.style.display = 'block';
            console.log('✅ Показана вкладка:', tabContent.id);
        } else {
            console.error('❌ Вкладка не найдена:', `${tabName}-tab`);
        }

        const tabButtons = document.querySelectorAll('.tab');
        tabButtons.forEach(button => {
            const buttonText = button.textContent.toLowerCase();
            if (buttonText.includes(tabName) ||
                tabName.includes(buttonText.replace(/[^a-zа-яё]/g, ''))) {
                button.classList.add('active');
            }
        });

        switch(tabName) {
            case 'dish-management':
                loadDishManagement();
                break;
            case 'menu':
                loadMenu();
                break;
            case 'profile':
                loadProfile();
                break;
            case 'orders':
                loadOrders();
                break;
            case 'purchases':
                loadPurchases();
                break;
            case 'reports':
                loadReports();
                break;
        }
    }

    async function loadMenu() {
        try {
            const category = document.getElementById('category-filter').value;
            const url = category ? `${API_URL}/menu?category=${category}` : `${API_URL}/menu`;
            
            const response = await fetch(url);
            const dishes = await response.json();
            
            const menuDiv = document.getElementById('menu');
            menuDiv.innerHTML = '';
            
            if (!dishes || dishes.length === 0) {
                menuDiv.innerHTML = '<p class="info">Нет доступных блюд</p>';
                return;
            }
            
            dishes.forEach(dish => {
                const div = document.createElement('div');
                div.className = 'menu-item';
                div.innerHTML = `
                    <h3>${dish.name}</h3>
                    <p style="color: #6b7280; margin: 10px 0;">
                        <span class="status ${dish.category === 'завтрак' ? 'pending' : 'served'}">
                            ${dish.category}
                        </span>
                    </p>
                    <p style="margin: 15px 0;">${dish.description || 'Описание отсутствует'}</p>
                    
                    ${dish.ingredients ? `
                        <p style="font-size: 0.9em; color: #4b5563;">
                            <strong>🍴 Состав:</strong> ${dish.ingredients}
                        </p>
                    ` : ''}
                    
                    ${dish.allergens ? `
                        <p style="color: #dc2626; font-size: 0.9em; margin: 10px 0;">
                            <strong>⚠️ Аллергены:</strong> ${dish.allergens}
                        </p>
                    ` : ''}
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                        <div>
                            <div style="font-size: 1.8em; font-weight: bold; color: #059669;">${dish.price} ₽</div>
                            <div style="font-size: 0.9em; color: ${dish.quantity > 0 ? '#6b7280' : '#dc2626'};">
                                ${dish.quantity > 0 ? `В наличии: ${dish.quantity} шт` : 'Нет в наличии'}
                            </div>
                        </div>
                        
                        ${currentUser && currentUser.role === 0 && dish.quantity > 0 ? `
                            <button onclick="createOrder(${dish.id})" 
                                    style="padding: 12px 24px; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                Заказать
                            </button>
                        ` : currentUser && currentUser.role === 0 && dish.quantity <= 0 ? `
                            <button disabled style="padding: 12px 24px; background: #9ca3af;">
                                Нет в наличии
                            </button>
                        ` : !currentUser ? `
                            <button onclick="showTab('login')" 
                                    style="padding: 12px 24px; background: #6b7280;">
                                Войдите для заказа
                            </button>
                        ` : ''}
                    </div>
                `;
                menuDiv.appendChild(div);
            });
            
        } catch (error) {
            console.error('Ошибка загрузки меню:', error);
            document.getElementById('menu').innerHTML = 
                '<div class="error">Ошибка загрузки меню. Проверьте соединение с сервером.</div>';
        }
    }


    async function login() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        console.log("🔍 DEBUG: Значения полей:", {username, password});

        if (!username || !password) {
            showMessage('login-result', 'Введите логин и пароль', 'error');
            return;
        }


        const requestData = {
            username: username.trim(),
            password: password.trim()
        };

        console.log("🔍 DEBUG: Данные для отправки:", requestData);
        console.log("🔍 DEBUG: JSON строка:", JSON.stringify(requestData));

        try {
            const response = await fetch('http://localhost:5000/api/auth/login', {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(requestData)
            });

            console.log("📋 DEBUG: Статус ответа:", response.status);
            console.log("📋 DEBUG: Заголовки ответа:");
            for (const [key, value] of response.headers.entries()) {
                console.log(`  ${key}: ${value}`);
            }


            const responseText = await response.text();
            console.log("📋 DEBUG: Тело ответа (сырое):", responseText);

            let data;
            try {
                data = JSON.parse(responseText);
                console.log("📋 DEBUG: Тело ответа (парсинг):", data);
            } catch (e) {
                console.error("❌ DEBUG: Не удалось распарсить JSON:", e);
                showMessage('login-result', '❌ Ошибка формата ответа от сервера', 'error');
                return;
            }

            if (response.ok && data.user) {
                currentUser = data.user;
                authToken = data.access_token;


                localStorage.setItem('token', authToken);
                localStorage.setItem('user', JSON.stringify(currentUser));

                updateUIAfterLogin();
                showMessage('login-result', '✅ Вход выполнен успешно!', 'success');


                setTimeout(() => showTab('menu'), 1000);

            } else {
                const errorMessage = data.error || data.message || 'Неизвестная ошибка';
                console.error("❌ DEBUG: Ошибка от сервера:", errorMessage);
                showMessage('login-result', `❌ ${errorMessage}`, 'error');
            }

        } catch (error) {
            console.error('❌ DEBUG: Ошибка сети:', error);
            showMessage('login-result', '❌ Ошибка подключения к серверу', 'error');
        }

    }

    async function register() {
        const username = document.getElementById('reg-username').value.trim();
        const password = document.getElementById('reg-password').value;
        const full_name = document.getElementById('reg-fullname').value.trim();
        const role = parseInt(document.getElementById('reg-role').value);
        const class_name = document.getElementById('reg-class').value.trim();

        console.log("📝 Данные регистрации:", {username, password, full_name, role, class_name});

        // Валидация
        if (!username || !password || !full_name) {
            showMessage('register-result', 'Заполните все обязательные поля', 'error');
            return;
        }

        if (password.length < 6) {
            showMessage('register-result', 'Пароль должен быть не менее 6 символов', 'error');
            return;
        }

        if (role === 0 && !class_name) {
            showMessage('register-result', 'Для ученика укажите класс', 'error');
            return;
        }

        try {
            const response = await fetch('http://localhost:5000/api/auth/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: username,
                    password: password,
                    full_name: full_name,
                    role: role,
                    class_name: class_name
                })
            });

            console.log("📋 Ответ сервера:", response.status);

            if (response.ok) {
                const data = await response.json();
                console.log("✅ Регистрация успешна:", data);


                currentUser = data.user;
                authToken = data.access_token;


                localStorage.setItem('token', authToken);
                localStorage.setItem('user', JSON.stringify(currentUser));

                updateUIAfterLogin();

                showMessage('register-result',
                    '✅ Регистрация успешна! Вы автоматически вошли в систему.',
                    'success');

                document.getElementById('reg-username').value = '';
                document.getElementById('reg-password').value = '';
                document.getElementById('reg-fullname').value = '';
                document.getElementById('reg-class').value = '';

                setTimeout(() => {
                    showTab('menu');
                    loadMenu();
                }, 2000);

            } else {
                const errorData = await response.json();
                console.error("❌ Ошибка регистрации:", errorData);
                showMessage('register-result',
                    `❌ Ошибка регистрации: ${errorData.error || 'Неизвестная ошибка'}`,
                    'error');
            }

        } catch (error) {
            console.error('🔥 Сетевая ошибка при регистрации:', error);
            showMessage('register-result',
                '❌ Ошибка подключения к серверу. Проверьте, запущен ли сервер на порту 5000.',
                'error');
        }
    }

    function logout() {
        currentUser = null;
        authToken = null;
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        
        updateUIAfterLogout();
        showTab('menu');
        showMessage('login-result', '✅ Вы вышли из системы', 'success');
    }


    async function createOrder(dishId) {
        if (!currentUser) {
            alert('Сначала войдите в систему!');
            showTab('login');
            return;
        }
        
        const mealType = prompt('Тип питания (завтрак/обед):', 'обед');
        const paymentType = prompt('Способ оплаты (разовый/абонемент):', 'разовый');
        
        if (!mealType || !paymentType) return;
        
        try {
            const response = await fetch(`${API_URL}/orders`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({
                    dish_id: dishId,
                    meal_type: mealType,
                    payment_type: paymentType
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                alert(`✅ Заказ #${data.order_id} создан успешно!`);
                loadMenu();
                loadOrders();
            } else {
                alert(`❌ Ошибка: ${data.error || 'Неизвестная ошибка'}`);
            }
            
        } catch (error) {
            alert('❌ Ошибка подключения к серверу');
        }
    }


    async function loadOrders() {
        if (!currentUser) {
            document.getElementById('orders-content').innerHTML = 
                '<p class="info">Для просмотра заказов необходимо войти в систему</p>';
            return;
        }
        
        try {
            const response = await fetch(`${API_URL}/orders/my`, {
                headers: {'Authorization': `Bearer ${authToken}`}
            });
            
            if (response.status === 401) {
                logout();
                return;
            }
            
            const orders = await response.json();
            const ordersDiv = document.getElementById('orders-content');
            
            if (!orders || orders.length === 0) {
                ordersDiv.innerHTML = '<p class="info">У вас пока нет заказов</p>';
                return;
            }
            
            let html = '<div class="grid">';
            orders.forEach(order => {
                html += `
                    <div class="order-item">
                        <h3>${order.dish_name}</h3>
                        <p><strong>Статус:</strong> 
                            <span class="status ${order.status}">${getStatusText(order.status)}</span>
                        </p>
                        <p><strong>Тип питания:</strong> ${order.meal_type || 'Не указано'}</p>
                        <p><strong>Способ оплаты:</strong> ${order.payment_type || 'Не указано'}</p>
                        <p><strong>Сумма:</strong> ${order.price} ₽</p>
                        <p><strong>Дата:</strong> ${new Date(order.order_date).toLocaleString('ru-RU')}</p>
                        ${order.status === 'pending' ? 
                            `<button onclick="cancelOrder(${order.id})" style="background: #ef4444; margin-top: 10px;">Отменить заказ</button>` : 
                            ''}
                    </div>
                `;
            });
            html += '</div>';
            
            ordersDiv.innerHTML = html;
            
        } catch (error) {
            console.error('Ошибка загрузки заказов:', error);
            document.getElementById('orders-content').innerHTML = 
                '<div class="error">Ошибка загрузки заказов</div>';
        }
    }

    async function cancelOrder(orderId) {
        if (!confirm('Вы уверены, что хотите отменить заказ?')) return;

        try {
            const response = await fetch(`http://localhost:5000/api/orders/${orderId}/cancel`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                }
            });

            console.log('Отмена заказа:', response.status);

            if (response.ok) {
                const data = await response.json();
                alert(data.message || '✅ Заказ отменен!');
                loadOrders(); // Обновляем список заказов
                loadProfile(); // Обновляем баланс
            } else {
                const errorData = await response.json();
                alert(`❌ Ошибка: ${errorData.error || 'Неизвестная ошибка'}`);
            }
        } catch (error) {
            console.error('Ошибка отмены заказа:', error);
            alert('❌ Ошибка подключения к серверу');
        }
    }
    async function loadProfile() {
        if (!currentUser) {
            document.getElementById('profile-content').innerHTML = 
                '<p class="info">Для просмотра профиля необходимо войти в систему</p>';
            return;
        }
        
        try {
            const response = await fetch(`${API_URL}/user/profile`, {
                headers: {'Authorization': `Bearer ${authToken}`}
            });
            
            if (response.status === 401) {
                logout();
                return;
            }
            
            const userData = await response.json();
            
            let html = `
                <div class="user-info">
                    <h3>👤 Ваш профиль</h3>
                    <p><strong>ФИО:</strong> ${userData.full_name}</p>
                    <p><strong>Логин:</strong> ${userData.username}</p>
                    <p><strong>Роль:</strong> ${getRoleName(userData.role)}</p>
                    <p><strong>Класс:</strong> ${userData.class_name || 'Не указан'}</p>
                    <p><strong>Баланс:</strong> <span class="balance">${userData.balance} ₽</span></p>
                    ${userData.allergies ? `<p><strong>Аллергии:</strong> ${userData.allergies}</p>` : ''}
                </div>
            `;
            
            if (userData.role === 0) {
                html += `
                    <div style="margin-top: 30px;">
                        <h3>💰 Пополнение баланса</h3>
                        <div style="display: flex; gap: 15px; margin-top: 15px;">
                            <input type="number" id="topup-amount" placeholder="Сумма" min="1" max="10000" value="100" style="flex: 1;">
                            <button onclick="topupBalance()">Пополнить</button>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="action-btn" onclick="document.getElementById('topup-amount').value=100">100 ₽</button>
                            <button class="action-btn" onclick="document.getElementById('topup-amount').value=500">500 ₽</button>
                            <button class="action-btn" onclick="document.getElementById('topup-amount').value=1000">1000 ₽</button>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('profile-content').innerHTML = html;
            
        } catch (error) {
            console.error('Ошибка загрузки профиля:', error);
            document.getElementById('profile-content').innerHTML = 
                '<div class="error">Ошибка загрузки профиля</div>';
        }
    }



    async function loadDishManagement() {
        if (!currentUser || currentUser.role !== 2) {
            document.getElementById('dish-management-content').innerHTML =
                '<p class="info">Для управления меню необходимо войти как администратор</p>';
            return;
        }

        try {
            // Загружаем все блюда
            const response = await fetch(`${API_URL}/dishes`, {
                headers: {'Authorization': `Bearer ${authToken}`}
            });

            if (response.status === 401) {
                logout();
                return;
            }

            const dishes = await response.json();
            const contentDiv = document.getElementById('dish-management-content');

            let html = `
            <div class="dashboard-header">
                <h3>Управление блюдами</h3>
                <button class="action-btn" onclick="showAddDishForm()">+ Добавить блюдо</button>
            </div>

            <div id="add-dish-form" style="display: none; margin: 30px 0; padding: 25px; background: #f8fafc; border-radius: 15px;">
                <h4>Добавить новое блюдо</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <input type="text" id="dish-name" placeholder="Название блюда *" style="margin-bottom: 15px;">
                        <textarea id="dish-description" placeholder="Описание" rows="3" style="margin-bottom: 15px; width: 100%;"></textarea>
                        <input type="text" id="dish-ingredients" placeholder="Ингредиенты" style="margin-bottom: 15px;">
                        <input type="text" id="dish-allergens" placeholder="Аллергены (через запятую)" style="margin-bottom: 15px;">
                    </div>
                    <div>
                        <select id="dish-category" style="margin-bottom: 15px;">
                            <option value="">Выберите категорию *</option>
                            <option value="завтрак">Завтрак</option>
                            <option value="обед">Обед</option>
                            <option value="напиток">Напиток</option>
                            <option value="выпечка">Выпечка</option>
                            <option value="десерт">Десерт</option>
                        </select>
                        <input type="number" id="dish-price" placeholder="Цена (руб) *" min="1" step="1" style="margin-bottom: 15px;">
                        <input type="number" id="dish-calories" placeholder="Калории" min="0" style="margin-bottom: 15px;">
                        <input type="number" id="dish-quantity" placeholder="Количество на складе" min="0" value="10" style="margin-bottom: 15px;">
                        <div style="display: flex; gap: 15px;">
                            <button onclick="addDish()" style="flex: 1;">Добавить блюдо</button>
                            <button onclick="hideAddDishForm()" style="background: #6b7280;">Отмена</button>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 30px;">
                <h3>Список блюд</h3>
                <div class="grid" style="margin-top: 20px;">
        `;

            if (!dishes || dishes.length === 0) {
                html += '<p class="info">Нет блюд в меню</p>';
            } else {
                dishes.forEach(dish => {
                    html += `
                    <div class="menu-item" style="position: relative;">
                        <div style="position: absolute; top: 15px; right: 15px; display: flex; gap: 10px;">
                            <button onclick="editDish(${dish.id})"
                                    style="padding: 5px 10px; font-size: 0.9em; background: #3b82f6;">✏️</button>
                            <button onclick="toggleDishAvailability(${dish.id})"
                                    style="padding: 5px 10px; font-size: 0.9em; background: ${dish.is_available ? '#f59e0b' : '#10b981'}">
                                ${dish.is_available ? '❌ Скрыть' : '✅ Показать'}
                            </button>
                        </div>

                        <h3>${dish.name}</h3>
                        <p style="color: #6b7280; margin: 10px 0;">
                            <span class="status ${dish.is_available ? 'served' : 'cancelled'}">
                                ${dish.category} • ${dish.is_available ? 'Доступно' : 'Недоступно'}
                            </span>
                        </p>
                        <p style="margin: 15px 0;">${dish.description || 'Описание отсутствует'}</p>

                        ${dish.ingredients ? `
                            <p style="font-size: 0.9em; color: #4b5563;">
                                <strong>🍴 Состав:</strong> ${dish.ingredients}
                            </p>
                        ` : ''}

                        ${dish.allergens ? `
                            <p style="color: #dc2626; font-size: 0.9em; margin: 10px 0;">
                                <strong>⚠️ Аллергены:</strong> ${dish.allergens}
                            </p>
                        ` : ''}

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                            <div>
                                <div style="font-size: 1.8em; font-weight: bold; color: #059669;">${dish.price} ₽</div>
                                <div style="font-size: 0.9em; color: #6b7280;">
                                    ${dish.calories ? `${dish.calories} ккал • ` : ''}
                                    На складе: ${dish.quantity} шт
                                </div>
                            </div>

                            <button onclick="deleteDish(${dish.id}, '${dish.name}')"
                                    style="padding: 10px 20px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                                Удалить
                            </button>
                        </div>
                    </div>
                `;
                });
            }

            html += `
                </div>
            </div>
        `;

            contentDiv.innerHTML = html;

        } catch (error) {
            console.error('Ошибка загрузки управления блюдами:', error);
            document.getElementById('dish-management-content').innerHTML =
                '<div class="error">Ошибка загрузки управления блюдами</div>';
        }
    }

    function showAddDishForm() {
        document.getElementById('add-dish-form').style.display = 'block';
    }

    function hideAddDishForm() {
        document.getElementById('add-dish-form').style.display = 'none';
    }

    async function addDish() {
        const name = document.getElementById('dish-name').value.trim();
        const description = document.getElementById('dish-description').value.trim();
        const category = document.getElementById('dish-category').value;
        const price = document.getElementById('dish-price').value;
        const ingredients = document.getElementById('dish-ingredients').value.trim();
        const allergens = document.getElementById('dish-allergens').value.trim();
        const calories = document.getElementById('dish-calories').value;
        const quantity = document.getElementById('dish-quantity').value;


        if (!name || !category || !price) {
            alert('Заполните обязательные поля (Название, Категория, Цена)');
            return;
        }

        if (price <= 0) {
            alert('Цена должна быть положительной');
            return;
        }

        try {
            const response = await fetch(`${API_URL}/dishes`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({
                    name: name,
                    description: description,
                    category: category,
                    price: parseFloat(price),
                    ingredients: ingredients,
                    allergens: allergens,
                    calories: calories ? parseInt(calories) : null,
                    quantity: parseInt(quantity) || 0
                })
            });

            if (response.ok) {
                const data = await response.json();
                alert(`✅ ${data.message}`);

                // Очищаем форму
                document.getElementById('dish-name').value = '';
                document.getElementById('dish-description').value = '';
                document.getElementById('dish-ingredients').value = '';
                document.getElementById('dish-allergens').value = '';
                document.getElementById('dish-price').value = '';
                document.getElementById('dish-calories').value = '';
                document.getElementById('dish-quantity').value = '10';

                loadDishManagement();
                loadMenu(); // Обновляем меню для всех пользователей

            } else {
                const errorData = await response.json();
                alert(`❌ Ошибка: ${errorData.error}`);
            }
        } catch (error) {
            console.error('Ошибка добавления блюда:', error);
            alert('❌ Ошибка подключения к серверу');
        }
    }

    async function editDish(dishId) {
        // Загружаем данные блюда
        try {
            const response = await fetch(`${API_URL}/dishes`, {
                headers: {'Authorization': `Bearer ${authToken}`}
            });

            if (response.ok) {
                const dishes = await response.json();
                const dish = dishes.find(d => d.id === dishId);

                if (!dish) {
                    alert('Блюдо не найдено');
                    return;
                }

                let html = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
                    <div style="background: white; padding: 30px; border-radius: 15px; width: 600px; max-width: 90%; max-height: 90%; overflow-y: auto;">
                        <h3>Редактирование блюда: ${dish.name}</h3>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Название</label>
                                <input type="text" id="edit-dish-name" value="${dish.name}" style="width: 100%; margin-bottom: 15px;">

                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Описание</label>
                                <textarea id="edit-dish-description" rows="3" style="width: 100%; margin-bottom: 15px;">${dish.description || ''}</textarea>

                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Ингредиенты</label>
                                <input type="text" id="edit-dish-ingredients" value="${dish.ingredients || ''}" style="width: 100%; margin-bottom: 15px;">

                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Аллергены</label>
                                <input type="text" id="edit-dish-allergens" value="${dish.allergens || ''}" style="width: 100%; margin-bottom: 15px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Категория</label>
                                <select id="edit-dish-category" style="width: 100%; margin-bottom: 15px;">
                                    <option value="завтрак" ${dish.category === 'завтрак' ? 'selected' : ''}>Завтрак</option>
                                    <option value="обед" ${dish.category === 'обед' ? 'selected' : ''}>Обед</option>
                                    <option value="напиток" ${dish.category === 'напиток' ? 'selected' : ''}>Напиток</option>
                                    <option value="выпечка" ${dish.category === 'выпечка' ? 'selected' : ''}>Выпечка</option>
                                    <option value="десерт" ${dish.category === 'десерт' ? 'selected' : ''}>Десерт</option>
                                </select>

                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Цена (руб)</label>
                                <input type="number" id="edit-dish-price" value="${dish.price}" min="1" step="1" style="width: 100%; margin-bottom: 15px;">

                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Калории</label>
                                <input type="number" id="edit-dish-calories" value="${dish.calories || ''}" min="0" style="width: 100%; margin-bottom: 15px;">

                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Количество</label>
                                <input type="number" id="edit-dish-quantity" value="${dish.quantity}" min="0" style="width: 100%; margin-bottom: 15px;">

                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                                    <input type="checkbox" id="edit-dish-available" ${dish.is_available ? 'checked' : ''}>
                                    Доступно для заказа
                                </label>
                            </div>
                        </div>

                        <div style="display: flex; gap: 15px; margin-top: 20px;">
                            <button onclick="updateDish(${dishId})" style="flex: 1;">Сохранить изменения</button>
                            <button onclick="closeEditForm()" style="background: #6b7280;">Отмена</button>
                        </div>
                    </div>
                </div>
            `;

                document.body.insertAdjacentHTML('beforeend', html);

            } else {
                alert('Ошибка загрузки данных блюда');
            }
        } catch (error) {
            console.error('Ошибка:', error);
            alert('Ошибка загрузки данных');
        }
    }

    function closeEditForm() {
        const modal = document.querySelector('div[style*="position: fixed"]');
        if (modal) modal.remove();
    }

    async function updateDish(dishId) {
        const name = document.getElementById('edit-dish-name').value.trim();
        const description = document.getElementById('edit-dish-description').value.trim();
        const category = document.getElementById('edit-dish-category').value;
        const price = document.getElementById('edit-dish-price').value;
        const ingredients = document.getElementById('edit-dish-ingredients').value.trim();
        const allergens = document.getElementById('edit-dish-allergens').value.trim();
        const calories = document.getElementById('edit-dish-calories').value;
        const quantity = document.getElementById('edit-dish-quantity').value;
        const is_available = document.getElementById('edit-dish-available').checked;

        if (!name || !category || !price) {
            alert('Заполните обязательные поля');
            return;
        }

        try {
            const response = await fetch(`${API_URL}/dishes/${dishId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({
                    name: name,
                    description: description,
                    category: category,
                    price: parseFloat(price),
                    ingredients: ingredients,
                    allergens: allergens,
                    calories: calories ? parseInt(calories) : null,
                    quantity: parseInt(quantity),
                    is_available: is_available
                })
            });

            if (response.ok) {
                const data = await response.json();
                alert(`✅ ${data.message}`);
                closeEditForm();
                loadDishManagement();
                loadMenu();
            } else {
                const errorData = await response.json();
                alert(`❌ Ошибка: ${errorData.error}`);
            }
        } catch (error) {
            console.error('Ошибка обновления:', error);
            alert('Ошибка подключения');
        }
    }

    async function toggleDishAvailability(dishId) {
        if (!confirm('Изменить доступность блюда?')) return;

        try {
            const response = await fetch(`${API_URL}/dishes/${dishId}/toggle`, {
                method: 'POST',
                headers: {'Authorization': `Bearer ${authToken}`}
            });

            if (response.ok) {
                const data = await response.json();
                alert(`✅ ${data.message}`);
                loadDishManagement();
                loadMenu();
            } else {
                const errorData = await response.json();
                alert(`❌ Ошибка: ${errorData.error}`);
            }
        } catch (error) {
            console.error('Ошибка:', error);
            alert('Ошибка подключения');
        }
    }

    async function deleteDish(dishId, dishName) {
        if (!confirm(`Удалить блюдо "${dishName}"? Это действие нельзя отменить.`)) return;

        try {
            const response = await fetch(`${API_URL}/dishes/${dishId}`, {
                method: 'DELETE',
                headers: {'Authorization': `Bearer ${authToken}`}
            });

            if (response.ok) {
                const data = await response.json();
                alert(`✅ ${data.message}`);
                loadDishManagement();
                loadMenu();
            } else {
                const errorData = await response.json();
                alert(`❌ ${errorData.error}`);
                if (errorData.suggestion) {
                    alert(`💡 Совет: ${errorData.suggestion}`);
                }
            }
        } catch (error) {
            console.error('Ошибка удаления:', error);
            alert('Ошибка подключения');
        }
    }



    async function topupBalance() {
        const amount = document.getElementById('topup-amount').value;
        
        if (!amount || amount <= 0) {
            alert('Введите корректную сумму');
            return;
        }
        
        try {
            const response = await fetch(`${API_URL}/balance/topup`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({amount: parseFloat(amount)})
            });
            
            const data = await response.json();
            
            if (response.ok) {
                alert(`✅ Баланс пополнен на ${amount} руб.!`);
                loadProfile();
            } else {
                alert(`❌ Ошибка: ${data.error || 'Неизвестная ошибка'}`);
            }
        } catch (error) {
            alert('❌ Ошибка подключения к серверу');
        }
    }


    async function loadPurchases() {
        if (!currentUser || (currentUser.role !== 1 && currentUser.role !== 2)) {
            document.getElementById('purchases-content').innerHTML =
                '<p class="info">Для работы с заявками необходимо войти как повар или администратор</p>';
            return;
        }

        try {
            const response = await fetch(`${API_URL}/purchases`, {
                headers: {'Authorization': `Bearer ${authToken}`}
            });

            if (response.status === 401) {
                logout();
                return;
            }

            const purchases = await response.json();
            const purchasesDiv = document.getElementById('purchases-content');

            if (!purchases || purchases.length === 0) {
                purchasesDiv.innerHTML = '<p class="info">Нет заявок на закупку</p>';
                return;
            }

            let html = '<div class="grid">';

            purchases.forEach(purchase => {
                html += `
                <div class="order-item">
                    <h3>${purchase.dish_name}</h3>
                    <p><strong>Статус:</strong>
                        <span class="status ${purchase.status}">${purchase.status === 'pending' ? 'Ожидает' :
                    purchase.status === 'approved' ? 'Утверждена' : 'Отклонена'}</span>
                    </p>
                    <p><strong>Количество:</strong> ${purchase.quantity}</p>
                    <p><strong>Создал:</strong> ${purchase.created_by_name}</p>
                    ${purchase.reason ? `<p><strong>Причина:</strong> ${purchase.reason}</p>` : ''}
                    <p><strong>Дата:</strong> ${new Date(purchase.created_at).toLocaleString('ru-RU')}</p>

                    ${currentUser.role === 2 && purchase.status === 'pending' ? `
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button onclick="approvePurchase(${purchase.id})"
                                    style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                Утвердить
                            </button>
                            <button onclick="rejectPurchase(${purchase.id})"
                                    style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                                Отклонить
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
            });

            html += '</div>';

            // Кнопка создания новой заявки для повара
            if (currentUser.role === 1) {
                html += `
                <div style="margin-top: 30px;">
                    <h3>Создать новую заявку</h3>
                    <div style="display: grid; gap: 15px; max-width: 500px;">
                        <input type="text" id="purchase-dish-name" placeholder="Название блюда/продукта">
                        <input type="number" id="purchase-quantity" placeholder="Количество" value="1" min="1">
                        <textarea id="purchase-reason" placeholder="Причина заявки" rows="3"></textarea>
                        <button onclick="createPurchase()">Создать заявку</button>
                    </div>
                </div>
            `;
            }

            purchasesDiv.innerHTML = html;

        } catch (error) {
            console.error('Ошибка загрузки заявок:', error);
            purchasesDiv.innerHTML = '<div class="error">Ошибка загрузки заявок</div>';
        }
    }

    async function loadReports() {
        if (!currentUser || currentUser.role !== 2) {
            document.getElementById('reports-content').innerHTML =
                '<p class="info">Для просмотра отчетов необходимо войти как администратор</p>';
            return;
        }

        try {
            const response = await fetch(`${API_URL}/reports/summary`, {
                headers: {'Authorization': `Bearer ${authToken}`}
            });

            if (response.status === 401) {
                logout();
                return;
            }

            const reports = await response.json();
            const reportsDiv = document.getElementById('reports-content');

            // Форматирование чисел
            function formatNumber(num) {
                return new Intl.NumberFormat('ru-RU').format(num);
            }

            function formatCurrency(amount) {
                return new Intl.NumberFormat('ru-RU', {
                    style: 'currency',
                    currency: 'RUB'
                }).format(amount);
            }

            let html = `
            <div class="dashboard-header">
                <h2>📊 Отчеты и статистика</h2>
                <div class="quick-actions">
                    <button class="action-btn" onclick="loadReports()">🔄 Обновить</button>
                    <button class="action-btn" onclick="loadDetailedReport()">📋 Детальный отчет</button>
                    <button class="action-btn" onclick="exportReports()">📥 Экспорт</button>
                </div>
            </div>

            <div class="stats-grid" style="margin-top: 20px;">
                <div class="stat-card">
                    <div class="stat-label">Всего пользователей</div>
                    <div class="stat-value">${reports.summary.total_users}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Всего заказов</div>
                    <div class="stat-value">${reports.summary.total_orders}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Всего блюд</div>
                    <div class="stat-value">${reports.summary.total_dishes}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Общая выручка</div>
                    <div class="stat-value">${formatCurrency(reports.summary.total_revenue)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Общий баланс</div>
                    <div class="stat-value">${formatCurrency(reports.summary.total_balance)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Заявок на закупку</div>
                    <div class="stat-value">${reports.summary.total_requests}</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 40px;">
                <div>
                    <h3>📈 Статистика заказов</h3>
                    <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.08);">
                        <p><strong>По статусам:</strong></p>
                        <ul style="margin-top: 10px;">
                            ${Object.entries(reports.orders.by_status).map(([status, count]) => `
                                <li>${getStatusText(status)}: <strong>${count}</strong></li>
                            `).join('')}
                        </ul>
                    </div>
                </div>

                <div>
                    <h3>🏷️ По категориям</h3>
                    <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); max-height: 300px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr>
                                    <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb;">Категория</th>
                                    <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb;">Заказы</th>
                                    <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb;">Выручка</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reports.categories.map(cat => `
                                    <tr>
                                        <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">${cat.category}</td>
                                        <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">${cat.order_count}</td>
                                        <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">${formatCurrency(cat.revenue || 0)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div style="margin-top: 40px;">
                <h3>🍽️ Популярные блюда</h3>
                <div class="grid" style="margin-top: 20px;">
                    ${reports.popular_dishes.map(dish => `
                        <div class="menu-item">
                            <h3>${dish.name}</h3>
                            <p><strong>Заказов:</strong> ${dish.order_count}</p>
                            <p><strong>Выручка:</strong> ${formatCurrency(dish.revenue || 0)}</p>
                        </div>
                    `).join('')}
                </div>
            </div>

            <div style="margin-top: 40px;">
                <h3>👥 Активные пользователи</h3>
                <div class="grid" style="margin-top: 20px;">
                    ${reports.active_users.map(user => `
                        <div class="user-info">
                            <h4>${user.full_name}</h4>
                            <p><strong>Логин:</strong> ${user.username}</p>
                            <p><strong>Заказов:</strong> ${user.order_count}</p>
                            <p><strong>Потрачено:</strong> ${formatCurrency(user.total_spent || 0)}</p>
                        </div>
                    `).join('')}
                </div>
            </div>

            <div style="margin-top: 40px; color: #6b7280; font-size: 0.9em;">
                <p>Отчет сгенерирован: ${new Date(reports.generated_at).toLocaleString('ru-RU')}</p>
            </div>
        `;

            reportsDiv.innerHTML = html;

        } catch (error) {
            console.error('Ошибка загрузки отчетов:', error);
            document.getElementById('reports-content').innerHTML =
                '<div class="error">Ошибка загрузки отчетов</div>';
        }
    }

    async function loadDetailedReport() {
        try {
            const response = await fetch(`${API_URL}/reports/detailed`, {
                headers: {'Authorization': `Bearer ${authToken}`}
            });

            if (response.ok) {
                const data = await response.json();

                let html = `
                <div class="dashboard-header">
                    <h2>📋 Детальный отчет</h2>
                    <button class="action-btn" onclick="loadReports()">← Назад к сводке</button>
                </div>

                <div class="tabs" style="margin: 20px 0;">
                    <div class="tab active" onclick="showReportTab('orders')">📦 Заказы</div>
                    <div class="tab" onclick="showReportTab('users')">👥 Пользователи</div>
                    <div class="tab" onclick="showReportTab('dishes')">🍽️ Блюда</div>
                </div>

                <div id="report-orders-tab">
                    <h3>Детальный отчет по заказам</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 12px; text-align: left;">ID</th>
                                    <th style="padding: 12px; text-align: left;">Дата</th>
                                    <th style="padding: 12px; text-align: left;">Блюдо</th>
                                    <th style="padding: 12px; text-align: left;">Цена</th>
                                    <th style="padding: 12px; text-align: left;">Статус</th>
                                    <th style="padding: 12px; text-align: left;">Пользователь</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.orders.map(order => `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 12px;">${order.id}</td>
                                        <td style="padding: 12px;">${new Date(order.order_date).toLocaleString('ru-RU')}</td>
                                        <td style="padding: 12px;">${order.dish_name}</td>
                                        <td style="padding: 12px;">${order.price} ₽</td>
                                        <td style="padding: 12px;"><span class="status ${order.status}">${getStatusText(order.status)}</span></td>
                                        <td style="padding: 12px;">${order.full_name} (${order.username})</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="report-users-tab" style="display: none;">
                    <h3>Детальный отчет по пользователям</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 12px; text-align: left;">ID</th>
                                    <th style="padding: 12px; text-align: left;">Пользователь</th>
                                    <th style="padding: 12px; text-align: left;">Роль</th>
                                    <th style="padding: 12px; text-align: left;">Класс</th>
                                    <th style="padding: 12px; text-align: left;">Баланс</th>
                                    <th style="padding: 12px; text-align: left;">Заказов</th>
                                    <th style="padding: 12px; text-align: left;">Потрачено</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.users.map(user => `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 12px;">${user.id}</td>
                                        <td style="padding: 12px;">${user.full_name} (${user.username})</td>
                                        <td style="padding: 12px;">${getRoleName(user.role)}</td>
                                        <td style="padding: 12px;">${user.class_name || '-'}</td>
                                        <td style="padding: 12px;">${user.balance} ₽</td>
                                        <td style="padding: 12px;">${user.total_orders}</td>
                                        <td style="padding: 12px;">${user.total_spent || 0} ₽</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="report-dishes-tab" style="display: none;">
                    <h3>Детальный отчет по блюдам</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 12px; text-align: left;">ID</th>
                                    <th style="padding: 12px; text-align: left;">Название</th>
                                    <th style="padding: 12px; text-align: left;">Категория</th>
                                    <th style="padding: 12px; text-align: left;">Цена</th>
                                    <th style="padding: 12px; text-align: left;">В наличии</th>
                                    <th style="padding: 12px; text-align: left;">Рейтинг</th>
                                    <th style="padding: 12px; text-align: left;">Заказов</th>
                                    <th style="padding: 12px; text-align: left;">Выручка</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.dishes.map(dish => `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 12px;">${dish.id}</td>
                                        <td style="padding: 12px;">${dish.name}</td>
                                        <td style="padding: 12px;">${dish.category}</td>
                                        <td style="padding: 12px;">${dish.price} ₽</td>
                                        <td style="padding: 12px;">${dish.quantity} шт</td>
                                        <td style="padding: 12px;">${dish.rating || 0}/5 (${dish.rating_count || 0})</td>
                                        <td style="padding: 12px;">${dish.order_count || 0}</td>
                                        <td style="padding: 12px;">${dish.revenue || 0} ₽</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div style="margin-top: 30px; color: #6b7280; font-size: 0.9em;">
                    <p>Отчет сгенерирован: ${new Date(data.generated_at).toLocaleString('ru-RU')}</p>
                </div>
            `;

                document.getElementById('reports-content').innerHTML = html;

                // Инициализация вкладок
                window.showReportTab = function(tabName) {
                    document.querySelectorAll('#reports-content .tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('#reports-content [id^="report-"]').forEach(t => t.style.display = 'none');

                    const tabBtn = Array.from(document.querySelectorAll('#reports-content .tab')).find(t =>
                        t.getAttribute('onclick').includes(`'${tabName}'`)
                    );
                    if (tabBtn) tabBtn.classList.add('active');

                    const tabContent = document.getElementById(`report-${tabName}-tab`);
                    if (tabContent) tabContent.style.display = 'block';
                };

            } else {
                alert('Ошибка загрузки детального отчета');
            }
        } catch (error) {
            console.error('Ошибка:', error);
            alert('Ошибка загрузки отчета');
        }
    }

    async function exportReports() {
        try {
            const response = await fetch(`${API_URL}/reports/export?format=json`, {
                headers: {'Authorization': `Bearer ${authToken}`}
            });

            if (response.ok) {
                const data = await response.json();

                // Создаем Blob для скачивания
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `school-cafe-report-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                alert('✅ Отчет экспортирован в формате JSON');
            } else {
                alert('Ошибка экспорта отчета');
            }
        } catch (error) {
            console.error('Ошибка экспорта:', error);
            alert('Ошибка экспорта отчета');
        }
    }

    async function createPurchase() {
        const dishName = document.getElementById('purchase-dish-name').value;
        const quantity = document.getElementById('purchase-quantity').value;
        const reason = document.getElementById('purchase-reason').value;

        if (!dishName.trim()) {
            alert('Введите название блюда/продукта');
            return;
        }

        try {
            const response = await fetch(`${API_URL}/purchases`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({
                    dish_name: dishName,
                    quantity: parseInt(quantity),
                    reason: reason
                })
            });

            if (response.ok) {
                alert('✅ Заявка создана!');
                document.getElementById('purchase-dish-name').value = '';
                document.getElementById('purchase-quantity').value = '1';
                document.getElementById('purchase-reason').value = '';
                loadPurchases();
            } else {
                const errorData = await response.json();
                alert(`❌ Ошибка: ${errorData.error}`);
            }
        } catch (error) {
            alert('❌ Ошибка подключения к серверу');
        }
    }

    async function approvePurchase(requestId) {
        if (!confirm('Утвердить заявку?')) return;

        try {
            const response = await fetch(`${API_URL}/purchases/${requestId}/approve`, {
                method: 'POST',
                headers: {'Authorization': `Bearer ${authToken}`}
            });

            if (response.ok) {
                alert('✅ Заявка утверждена!');
                loadPurchases();
            } else {
                const errorData = await response.json();
                alert(`❌ Ошибка: ${errorData.error}`);
            }
        } catch (error) {
            alert('❌ Ошибка подключения к серверу');
        }
    }

    async function rejectPurchase(requestId) {
        if (!confirm('Отклонить заявку?')) return;

        try {
            const response = await fetch(`${API_URL}/purchases/${requestId}/reject`, {
                method: 'POST',
                headers: {'Authorization': `Bearer ${authToken}`}
            });

            if (response.ok) {
                alert('✅ Заявка отклонена!');
                loadPurchases();
            } else {
                const errorData = await response.json();
                alert(`❌ Ошибка: ${errorData.error}`);
            }
        } catch (error) {
            alert('❌ Ошибка подключения к серверу');
        }
    }

    async function serveOrder(orderId) {
        try {
            const response = await fetch(`${API_URL}/orders/${orderId}/serve`, {
                method: 'POST',
                headers: {'Authorization': `Bearer ${authToken}`}
            });

            if (response.ok) {
                alert('✅ Заказ отмечен как выданный!');
                loadOrders();
            } else {
                const errorData = await response.json();
                alert(`❌ Ошибка: ${errorData.error}`);
            }
        } catch (error) {
            alert('❌ Ошибка подключения к серверу');
        }
    }



    async function checkDb() {
        try {
            const response = await fetch(`${API_URL}/menu`);
            const data = await response.json();
            document.getElementById('db-status').textContent = '✅';
            document.getElementById('db-status').style.color = '#10b981';
        } catch (error) {
            document.getElementById('db-status').textContent = '❌';
            document.getElementById('db-status').style.color = '#ef4444';
        }
    }



    async function testDoubleOrder() {
        if (!currentUser) {
            alert('Сначала войдите в систему');
            return;
        }

        try {
            const response = await fetch(`${API_URL}/test/double-order`, {
                method: 'POST',
                headers: {'Authorization': `Bearer ${authToken}`}
            });

            const data = await response.json();
            document.getElementById('test-results').innerHTML =
                `<div class="success">${data.message || 'Тест выполнен'}</div>`;
        } catch (error) {
            document.getElementById('test-results').innerHTML =
                `<div class="error">Ошибка тестирования</div>`;
        }
    }




    function updateUIAfterLogin() {
        document.getElementById('current-user').style.display = 'block';
        document.getElementById('user-name').textContent = currentUser.full_name;
        document.getElementById('user-role').textContent = getRoleName(currentUser.role);
        document.getElementById('user-balance').textContent = `${currentUser.balance} ₽`;
    }


    function updateUIAfterLogout() {
        document.getElementById('current-user').style.display = 'none';
        document.getElementById('profile-content').innerHTML = 
            '<p class="info">Для просмотра профиля необходимо войти в систему</p>';
        document.getElementById('orders-content').innerHTML = 
            '<p class="info">Для просмотра заказов необходимо войти в систему</p>';
    }


    function showMessage(elementId, message, type) {
        const element = document.getElementById(elementId);
        element.innerHTML = `<div class="${type}">${message}</div>`;
    }


    function getRoleName(role) {
        switch(role) {
            case 0: return '👨‍🎓 Ученик';
            case 1: return '👨‍🍳 Повар';
            case 2: return '👨‍💼 Администратор';
            default: return 'Неизвестно';
        }
    }



    function getStatusText(status) {
        const statusMap = {
            'pending': 'Ожидает',
            'served': 'Выдан',
            'cancelled': 'Отменен',
            'approved': 'Утвержден',
            'rejected': 'Отклонен'
        };
        return statusMap[status] || status;
    }


    window.onload = function() {
        checkServer();
        checkAuth();
        loadMenu();
    };
</script>
</body>
</html>